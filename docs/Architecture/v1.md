# Kiến trúc tổng thể nền tảng e‑commerce

## 1) Mục tiêu & nguyên tắc

* **Khả năng mở rộng theo miền** (domain-driven): Product, Cart, Order, Payment, Inventory, Shipping, Notification, Auth, Chat, Agent hoạt động độc lập.
* **Resilience**: tự phục hồi, cô lập lỗi, backpressure, fallback.
* **Real‑time & event‑driven**: Kafka làm xương sống dữ liệu thời gian thực (flash sale, analytics, notification, audit). REST/gRPC chỉ dùng khi cần đồng bộ/truy vấn.
* **Bảo mật trước hết**: Zero‑trust nội bộ, JWT/OIDC ở rìa, RBAC theo miền dữ liệu, phân vùng PCI cho Payment.
* **Quan sát được**: logs có tương quan, metrics chuẩn RED/USE, distributed tracing.
* **Tự động hoá**: build → scan → test → deploy (CI/CD) trên Kubernetes.

## 2) Sơ đồ logic (mô tả)

Client (Web MFE React/Vue, Mobile) → **API Gateway** → các **Domain Services** (Auth, Product, Cart, Order, Payment, Inventory, Shipping, Notification, Chat, Agent) → Databases (Postgres/Mongo/Redis).
Sự kiện xuyên miền chạy trên **Kafka**. Realtime (websocket) qua **Chat/Notification**. Tất cả chạy trên **Kubernetes**, đóng gói **Docker**, mô tả API bằng **Swagger/OpenAPI**.

## 3) Phân vùng miền (Bounded Contexts) & dịch vụ

### Auth Service (Spring Boot, Postgres)

* OIDC/OAuth2 + JWT (access/refresh). JTI + danh sách thu hồi trong Redis.
* RBAC/ABAC theo scope. MFA/Email OTP (qua Notification).
* Xuất sự kiện: `user.registered`, `user.profile.updated`.

### Product Service (Golang, Mongo + Redis cache)

* Danh mục, thuộc tính, biến thể, giá, khuyến mãi áp dụng, SEO.
* Tìm kiếm/lọc (Mongo + chỉ mục tổng hợp). Cache đọc nóng trong Redis, TTL ngắn.
* Sự kiện: `product.created|updated|price.changed|promo.changed`.

### Cart Service (Node/Express, Redis + Postgres)

* Giỏ tạm (guest) lưu Redis với TTL; giỏ người dùng đồng bộ về Postgres để bền vững.
* Tính phí ship sơ bộ, voucher áp dụng (qua Agent/Promotion API), ước tính tồn kho (Inventory read model).
* Sự kiện: `cart.created|updated|abandoned`.

### Order Service (Spring Boot, Postgres)

* Orchestrator của **Order Saga** (đặt hàng → giữ hàng → thanh toán → giao).
* Trạng thái: Pending, Reserved, Paid, Packed, Shipped, Cancelled, Refunded.
* Idempotency keys cho `placeOrder`. Outbox pattern phát `order.created|paid|cancelled|fulfilled`.

### Payment Service (Python, Postgres/Redis)

* Tích hợp cổng thanh toán nội địa/quốc tế, webhook xác nhận.
* Khu vực **PCI boundary** tách biệt mạng/secret. Tokenize phương thức thanh toán.
* Sự kiện: `payment.authorized|captured|failed|refunded`.

### Inventory Service (Golang, Postgres + Redis)

* Stock per SKU/location; chiến lược **reservation** cho flash sale.
* **Atomic**: giảm tồn/đặt giữ qua hàng đợi + khoá lạc quan; Redis dùng cho quota nhanh (Lua/INCR) nhưng nguồn sự thật ở Postgres.
* Sự kiện: `inventory.reserved|released|deducted|replenished`.

### Shipping Service (Node/Express, Postgres)

* Tính phí ship, tạo vận đơn, theo dõi trạng thái vận chuyển.
* Sự kiện: `shipment.created|status.changed|delivered`.

### Notification Service (Node/Express, Mongo + Redis)

* Kênh: Email, SMS, Push, WebSocket in‑app. Mẫu (template) lưu Mongo.
* Queue consumer từ `*.notification.requested` và gửi theo chính sách retry.

### Chat Service (Node/Express, WebSocket, Redis pub/sub)

* Hỗ trợ khách hàng, phòng chat theo phiên, lưu transcript nhẹ (Mongo) nếu cần.
* Realtime presence (đếm người đang xem sản phẩm) qua Redis + stream ra Kafka cho phân tích.

### Agent Service (Python, Postgres/Mongo + pgvector tuỳ chọn)

* **AI Agent** tư vấn khuyến mãi, cross‑sell, up‑sell.
* Công cụ (tools): Product Search, Promotion Engine, Cart Ops, Order Status.
* RAG trên dữ liệu sản phẩm/khuyến mãi; guardrails & audit.
* Sự kiện: `agent.recommendation.shown|accepted`.

## 4) Giao tiếp & tích hợp

* **API Gateway**: định tuyến, xác thực JWT, rate‑limit, request/response mapping, canary.
* **Async** với Kafka: event (facts) và command (yêu cầu) tách topic.
* **Topic naming**: `<domain>.<entity>.<event>` (vd: `order.order.paid`). Partition theo key nghiệp vụ (userId, orderId, sku).
* **Schema**: JSON Schema/Avro; quản lý version hoá, backward‑compatible. Outbox/Inbox pattern để đảm bảo **exactly‑once effect** (ít nhất một lần + idempotency).
* **Sync** nội bộ: REST (OpenAPI) hoặc gRPC cho gọi nhỏ độ trễ thấp (vd: Pricing).

## 5) Dữ liệu & lưu trữ

* **Postgres**: giao dịch lõi (Auth, Order, Payment, Inventory, Shipping).
* **Mongo**: catalog sản phẩm, nội dung linh hoạt, template thông báo, chat transcript.
* **Redis**: cache, session/giỏ tạm, rate limit, counter realtime (viewer, flash sale quota), distributed lock nhẹ.
* **Read model**: tạo bảng/collection phục vụ truy vấn nhanh (CQRS nhẹ) tiêu thụ từ Kafka.

## 6) Tính nhất quán & giao dịch phân tán

* **Order Saga** (orchestration ở Order Service):

  1. `order.created` → Inventory Reserve (command) → `inventory.reserved`/`inventory.reserve.failed`
  2. Nếu reserved: yêu cầu Payment authorize → `payment.authorized|failed`
  3. Nếu authorized: xác nhận đơn → `order.paid` và phát `notification.requested`
  4. Nếu bước nào thất bại: phát **compensation** (release stock, cancel order).
* **Idempotency**: mọi endpoint ghi có `Idempotency-Key`; consumer sử dụng **dedup store** (Redis/Postgres).

## 7) Flash sale & realtime

* Hàng nóng (SKU flash sale): quota ở Redis với Lua script **decrement-if-available**; nếu thành công → enqueue command `reserve` qua Kafka; nếu thất bại trả hết hàng.
* **Backpressure**: gateway + queue + consumer autoscale. Chặn “thắng thầu kép” bằng reservation TTL.
* Người xem sản phẩm: WebSocket cập nhật đếm từ Redis; batch gửi analytics lên Kafka.

## 8) Micro‑frontend

* **Shell** Astro (SSR, SEO) chứa layout, auth, i18n, route.
* Mỗi domain một MFE **React/Vue** (Module Federation/single‑spa). Deploy độc lập, versioned.
* Giao tiếp MFE qua event bus trình duyệt/URL state; tránh coupling.
* BFF tuỳ chọn cho Mobile/Web nếu cần bóc tách API.

## 9) Bảo mật & tuân thủ

* JWT ký bằng RSA/ECDSA; rotate keys. Refresh token có TTL/lifetime ràng buộc thiết bị.
* Mã hoá at‑rest & in‑transit (TLS, Secrets). mTLS nội bộ tùy mức nhạy cảm.
* **PCI boundary**: Payment tách namespace, secret, network policy. Không lưu PAN raw.
* Rate limit theo IP/user, WAF ở rìa. Nhật ký bảo mật, cảnh báo bất thường.

## 10) Observability

* **Logs** cấu trúc (correlationId, userId, orderId).
* **Metrics**: RED cho service, SLIs chính (latency P95, error rate, saturation).
* **Tracing**: OpenTelemetry.
* **Alerting**: SLO‑based, runbook cho sự cố thường gặp.

## 11) Triển khai trên Kubernetes

* **Namespaces**: ingress, core (gateway), domain (auth, product, …), data (db/cache), observability, pci (payment).
* **Helm/Manifest**: HPA, PDB, liveness/readiness, resource requests/limits, topology spread.
* **Ingress**: HTTP/2 + WebSocket. Sticky session chỉ khi buộc phải dùng (ưu tiên stateless).
* **Stateful**: Postgres/Mongo/Redis chạy dạng managed hoặc StatefulSet có backup.
* **Secrets/Config**: Secret + ConfigMap, sealed secret/Vault tuỳ chọn.
* **Deploy**: blue‑green/canary, rollback tự động.

## 12) CI/CD & chất lượng

* Pipeline: build Docker → unit/integration → contract test (OpenAPI, consumer‑driven) → security scan → deploy staging → e2e → promote prod.
* **API First**: OpenAPI/Swagger là nguồn sự thật; sinh client/server stub; kiểm soát breaking change.
* **Test**: test saga, chaos test (latency/packet loss), performance test theo SKU nóng.

## 13) Phi chức năng & SLO gợi ý

* Web P95 ≤ 300ms cho read, ≤ 800ms cho write thông thường; flash sale đường nóng ≤ 200ms cho reserve.
* Tính sẵn sàng: 99.9% toàn hệ, 99.95% cho Gateway/Auth.
* Recovery: RPO ≤ 5 phút, RTO ≤ 15 phút.

## 14) Roadmap triển khai

* **MVP**: Gateway, Auth, Product, Cart, Inventory (reserve cơ bản), Order, Payment (capture/authorize), Notification, Web MFE, Observability nền tảng.
* **Phase 2**: Shipping, Chat realtime, Agent AI (RAG + tool use), Pricing nâng cao, Analytics thời gian thực, CDC/outbox hoàn chỉnh, canary toàn hệ.
* **Phase 3**: Multi‑region active‑active cho read, DR site, tính năng loyalty, voucher engine chuyên biệt.

## 15) Rủi ro & đối sách

* **Oversell flash sale** → Redis atomic + reservation TTL + idempotency + kiểm tồn hậu kiểm.
* **Webhook giả mạo thanh toán** → xác thực chữ ký, xác minh server‑to‑server, trạng thái payment hữu hạn.
* **Thắt cổ chai đọc** → CQRS + cache + precompute read model.
* **Nợ kỹ thuật MFE** → chuẩn hoá design system, versioning, lint CI.

## 16) Phụ lục thực thi

* **Kafka topics** (ví dụ): `user.registered`, `product.updated`, `inventory.reserved`, `order.created|paid|cancelled`, `payment.authorized|failed`, `shipment.created|status.changed`, `notification.requested`, `agent.recommendation.shown`.
* **HTTP lỗi chuẩn**: code, message, correlationId, details\[], retriable?, docsUrl.
* **Chuẩn Swagger**: mô tả auth header, pagination, lọc/sắp xếp, idempotency, lỗi chuẩn hoá.
* **Quy ước version**: API v1/v2 qua URL/headers; sự kiện version bằng schema registry.
